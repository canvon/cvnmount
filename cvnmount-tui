#!/bin/bash

BASENAME="${0##*/}"

warn() {
	echo "$BASENAME: $*" >&2
}

die() {
	warn "Fatal: $*"
	exit 1
}


action-mount() {
	USER_DSTS=()

	while read SRC DST TYPE OPTS DUMMY
	do
		grep -q -E '(^|,)users?(,|$)' <<<"$OPTS" || continue

		# Append to bash array.
		USER_DSTS=("${USER_DSTS[@]}" "$DST")
	done </etc/fstab

	echo
	echo "Select a user-mountable mount point to mount:"
	echo

	local PS3="$BASENAME mount> "

	select DST in "${USER_DSTS[@]}"
	do
		[ -n "$DST" ] || { echo "Exit $BASENAME action mount."; break; }

		echo "Mounting $DST ..."
		mount "$DST" || warn "Error: Mounting $DST failed"
	done
}

action-umount() {
	warn "Action umount: Not implemented, yet."
	return 1
}

action-list-mounts() {
	warn "Action list mounts: Not implemented, yet."
	return 1
}

action-kerberos() {
	warn "Action Kerberos: Not implemented, yet."
	return 1
}


echo "What do you want to do today?"

hint() {
	echo
	echo "Hint: Enter the number of an option you want to invoke,"
	echo "      or 0 or ^D (Ctrl-D, End-of-Transmission) to exit"
	echo "      to enclosing scope. Press enter without any input"
	echo "      to repeat the list of options."
	echo
}
hint

ORIG_PS3="$PS3"

PS3="$BASENAME> "

VALID_ACTIONS=(mount umount list-mounts kerberos)
select ACTION in "${VALID_ACTIONS[@]}"
do
	if [ -z "$ACTION" ]
	then
		case "$REPLY" in
		\?|help)
			hint
			continue
			;;
		0|exit|quit)
			echo "Exit $BASENAME."
			break
			;;
		*)
			# Try to lookup an action for the reply string-wise.
			for OTHER_ACTION in "${VALID_ACTIONS[@]}"
			do
				if [ "$REPLY" = "$OTHER_ACTION" ]
				then
					ACTION="$OTHER_ACTION"
					break
				fi
			done

			# Still no action to invoke?
			if [ -z "$ACTION" ]
			then
				warn "Invalid reply \"$REPLY\"!"
				continue
			fi
			# Otherwise, fall-through.
			;;
		esac
	fi

	action-"$ACTION" || warn "Warning: Action \"$ACTION\" seems to have been unsuccessful."
done

exit 0
